trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  STORAGE_ACCOUNT_NAME: 'stdmgmtday8'
  CONTAINER_NAME: 'raw'
  BLOB_FILE_NAME: 'ce_brand_detail.csv'
  SQL_SERVER: 'minukserver.database.windows.net'
  DATABASE: 'dmgmt_day8'
  USERNAME: 'mc79857'
  PASSWORD: 'Ïó¨Í∏∞Ïóê_ÎπÑÎ∞ÄÎ≤àÌò∏_ÏûÖÎ†•'   # üîí Ï†àÎåÄ Í≥µÍ∞ú Ï†ÄÏû•ÏÜåÏóê Ïò¨Î¶¨ÏßÄ Îßê Í≤É
  TABLE_NAME: 'ce_brand_detail'

steps:
- task: AzureCLI@2
  inputs:
    azureSubscription: 'Azure subscription connection name'  # Azure DevOpsÏóê Ïó∞Í≤∞Îêú ÏÑúÎπÑÏä§ Ïù¥Î¶Ñ
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "Downloading CSV file from Azure Blob Storage..."
      az storage blob download \
        --account-name $(STORAGE_ACCOUNT_NAME) \
        --container-name $(CONTAINER_NAME) \
        --name $(BLOB_FILE_NAME) \
        --file $(BLOB_FILE_NAME) \
        --auth-mode key

      echo "Uploading CSV data into Azure SQL Database..."
      sqlcmd -S $(SQL_SERVER) -d $(DATABASE) -U $(USERNAME) -P $(PASSWORD) -Q "
      BULK INSERT $(TABLE_NAME)
      FROM '$(System.DefaultWorkingDirectory)/$(BLOB_FILE_NAME)'
      WITH (
          DATA_SOURCE = 'MyBlobStore',
          FORMAT='CSV',
          FIRSTROW = 2,
          FIELDTERMINATOR = ',',
          ROWTERMINATOR = '0x0a'
      );"
  displayName: 'Load CSV from Blob into Azure SQL'

- script: echo "‚úÖ Data load process completed successfully!"
  displayName: 'Confirm completion'
